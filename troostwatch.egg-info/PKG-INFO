Metadata-Version: 2.4
Name: troostwatch
Version: 0.7.0
Summary: Scrape Troostwijk auctions, track bids, analyse exposure and view results via a CLI.
Author-email: Jochem <jochem@example.com>
License: MIT
Requires-Python: >=3.11
Description-Content-Type: text/markdown
Requires-Dist: click>=8.3
Requires-Dist: beautifulsoup4>=4.14
Requires-Dist: requests>=2.32
Requires-Dist: rich>=14.0
Requires-Dist: aiohttp>=3.13
Requires-Dist: PyYAML>=6.0
Requires-Dist: fastapi>=0.122
Requires-Dist: uvicorn>=0.38
Requires-Dist: websockets>=15.0
Requires-Dist: pydantic>=2.12
Provides-Extra: dev
Requires-Dist: pytest>=9.0; extra == "dev"
Requires-Dist: black>=24.0; extra == "dev"
Requires-Dist: flake8>=7.0; extra == "dev"
Requires-Dist: mypy>=1.13; extra == "dev"
Requires-Dist: import-linter>=2.1; extra == "dev"
Provides-Extra: docs
Requires-Dist: markdown-it-py>=2.2; extra == "docs"

# Troostwatch

This repository hosts the code for the Troostwatch project.

It provides a set of tools to scrape Troostwijk auctions, store the data in a SQLite database, analyse your bidding exposure and display a live overview via a command‑line interface.

## Key Features

- **Auction sync**: Scrape lots from Troostwijk auction pages with concurrent fetching and rate limiting
- **Brand extraction**: Automatically extract brand/manufacturer from lot specifications
- **Bid history**: Track historical bids on lots as scraped from detail pages
- **Buyer management**: Create and manage buyer identities for bidding
- **Position tracking**: Track which lots you're interested in with budget limits
- **Exposure reporting**: Calculate your minimum/maximum exposure across tracked lots
- **Web UI**: Filter and browse lots with brand filtering support
- **Real-time updates**: WebSocket support for live lot updates

## Project structure

Troostwatch volgt een gelaagde indeling zodat domeinlogica, infrastructuur en interfaces duidelijk gescheiden blijven:

- `troostwatch/domain/` – domeinmodellen en analytische hulpfuncties die geen directe afhankelijkheid op I/O hebben.
- `troostwatch/infrastructure/` – adapters voor opslag, HTTP en HTML-parsing (`web/parsers`), logging en diagnostics.
- `troostwatch/services/` – coördinerende services zoals sync-workflows en biedlogica.
- `troostwatch/interfaces/cli/` – CLI-entrypoints en facades die de Click-commando’s beschikbaar maken.
- `troostwatch/app/` – applicatie-coördinatie, inclusief configuratie-facades voor CLI en services.

Om bestaande imports te beschermen tijdens de migratie bevat iedere nieuwe laag een alias/facade die doorverwijst naar de legacy-modules. De console scripts in `pyproject.toml` gebruiken nu de nieuwe CLI-facades, terwijl de oorspronkelijke modules bruikbaar blijven. Geleidelijke migratie is zo mogelijk: bestaande code kan blijven verwijzen naar `troostwatch.cli.*` of `troostwatch.parsers.*`, terwijl nieuwe code de gelaagde namen gebruikt.

### Mapping van legacy-modules naar de gelaagde structuur

| Legacy-pad                          | Nieuw laag-pad                                            |
| ----------------------------------- | --------------------------------------------------------- |
| `troostwatch.cli.*`                 | `troostwatch.interfaces.cli.*`                            |
| `troostwatch.parsers.*`             | `troostwatch.infrastructure.web.parsers.*`                 |
| `troostwatch.sync.*`                | `troostwatch.services.sync.*`                             |
| `troostwatch.analytics`             | `troostwatch.domain.analytics`                            |
| `troostwatch.models`                | `troostwatch.domain.models`                               |
| `troostwatch.db`                    | `troostwatch.infrastructure.persistence.db`               |
| `troostwatch.http_client`           | `troostwatch.infrastructure.http`                         |
| `troostwatch.logging_utils`         | `troostwatch.infrastructure.observability.logging`        |
| `troostwatch.debug_tools`           | `troostwatch.infrastructure.diagnostics.debug_tools`      |
| `troostwatch.config`                | `troostwatch.app.config`                                  |

Plan voor gefaseerde import-updates:

1. Nieuwe code importeert primair via de gelaagde namen uit de tabel hierboven.
2. Legacy-imports blijven beschikbaar via de facades zodat bestaande scripts blijven draaien.
3. Tijdens toekomstige refactors kunnen modules per laag verplaatst worden zonder externe breuken; pas daarna worden de legacy-paden uitgefaseerd.

> **Deprecation notice:** het `troostwatch.cli.*` pad geeft nu een
> `DeprecationWarning` bij import. Gebruik `troostwatch.interfaces.cli.*` voor
> CLI-commando’s en module-executie. Het legacy pad blijft tijdelijk werken
> zodat bestaande scripts kunnen migreren.

Examples voor de `view` command, die opgeslagen lots laat zien met optionele filters en een JSON‑outputmodus:

```bash
# Bekijk alle lots in een lokale SQLite database
python -m troostwatch.cli view --db troostwatch.db

# Filter op een specifieke veiling en toon maximaal 20 lots als JSON
python -m troostwatch.cli view --db troostwatch.db --auction-code A1-39499 --limit 20 --json-output

# Toon alleen open lots, bijvoorbeeld na een sync run
python -m troostwatch.cli view --db troostwatch.db --state open

# Toon alle lots zonder limiet en formatteer als tekst
python -m troostwatch.cli view --db troostwatch.db --limit 0
```

## Architecture and Agents

Troostwatch uses a layered architecture (`domain` → `services` → `app`/`interfaces` → `ui`) with `infrastructure` as a side-layer for adapters. This separation keeps business logic testable and independent from I/O concerns.

Contributor guidelines and role-specific instructions live in:
- `AGENTS.md` – project-wide rules, build commands, and architecture overview
- `.github/agents/*.md` – specialised agent files for docs, tests, API, CLI, etc.

See `docs/architecture.md` for layer rules and `docs/review_checklist.md` for PR review guidelines.

## Requirements and installation

This project depends on a small number of third‑party libraries. To use the
command‑line interface you must install these dependencies into your Python
environment. The recommended way is via `pip` and the supplied
`requirements.txt` file:

```bash
python -m venv .venv
source .venv/bin/activate  # on Windows use `.venv\Scripts\activate`
pip install -r requirements.txt
```

At minimum the CLI requires [Click](https://click.palletsprojects.com/) for
defining commands and [PyYAML](https://pyyaml.org/) for reading the YAML
configuration file used by the `sync-multi` command. Parsing HTML responses relies
on [BeautifulSoup](https://www.crummy.com/software/BeautifulSoup/), and the sync
pipeline depends on both [aiohttp](https://docs.aiohttp.org/) and
[requests](https://requests.readthedocs.io/) to support concurrent fetching with
retries and rate limiting. For richer terminal output you can also install
[Rich](https://rich.readthedocs.io/). All of these are listed in
configuration file used by the `sync-multi` command. The sync pipeline also
depends on [aiohttp](https://docs.aiohttp.org/) and [requests](https://requests.readthedocs.io/) to
support concurrent fetching with retries and rate limiting. These are listed in
`requirements.txt` for convenience.

Listing pages and lot details are hashed to detect changes between sync runs.
The `sync` and `sync-multi` CLI commands expose `--max-concurrent-requests`,
`--throttle-per-host`, retry/backoff toggles and `--skip-unchanged-details`
behaviour so you can tune performance while avoiding unnecessary requests.

With the virtual environment activated you can invoke the CLI entry points via
`python -m troostwatch.cli`. Below are some common commands:

```bash
# Add a buyer
python -m troostwatch.cli buyer add Jochem --name "Jochem" --notes "IS IT engineer"

# Track a specific lot with an optional budget
python -m troostwatch.cli positions add --db troostwatch.db Jochem A1-39499 1234 --budget 2500

# View a summary of your exposure for a buyer
python -m troostwatch.cli report buyer --db troostwatch.db Jochem
```

There is also a `schema` directory containing the database schema and any migrations, a `scripts` directory for one‑off scripts such as `firstrun.py`, and a `tests` directory containing unit tests. The `examples` directory holds example configuration and data files to help new users get started.

### New commands in version 0.6.0

Recent versions have greatly expanded the CLI. In addition to the core `sync` command, you can now:

- **buyer** – create, list and delete buyers. Each buyer represents one identity you use to bid.
- **positions** – track specific lots for a buyer, optionally with a maximum budget, and mark them active or inactive.
- **report** – generate exposure summaries for a buyer, including the number of tracked lots and your minimum/maximum exposure based on current bids and budgets.
- **sync-multi** – synchronise multiple auctions at once from a YAML file.
- **debug** – inspect your local database. Subcommands let you view row counts per table, run an integrity check, or show rows from a specific table.

These commands can be invoked via `python -m troostwatch.cli <command>`. Gebruik `view` om opgeslagen lots te bekijken (met filters voor veilingcode, status en limiet, plus een JSON‑uitvoeroptie), `report buyer` voor een overzicht van je exposure en `debug view` om tabellen rechtstreeks te inspecteren. See the examples above and the documentation in `docs/` for more details.

### New in version 0.7.0

Version 0.7.0 adds brand and bid history support:

- **Brand extraction**: The lot detail parser extracts brand/manufacturer from lot specifications (supports `Merk`, `Brand`, `Fabricaat` keys).
- **Bid history tracking**: Historical bids are scraped from lot detail pages and stored in the new `bid_history` table.
- **Brand filtering**: The UI and API now support filtering lots by brand via the `brand` query parameter.
- **Schema update**: Database schema version 2 adds the `brand` column to `lots` and creates the `bid_history` table. Existing databases are migrated automatically.

## API-server starten

Naast de CLI kun je de ingebouwde FastAPI-app gebruiken om lots, buyers en posities via HTTP of WebSocket te beheren. Start de server met:

```bash
uvicorn troostwatch.app.api:app --reload
```

De API gebruikt de bestaande SQLite-databasepaden uit `config.json` en publiceert live lot-updates via `/ws/lots`.
